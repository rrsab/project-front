<html lang="RU">
<head>
    <meta charset="UTF-8">
    <title>RPG</title>
    <script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
    <link href="/css/my.css" rel="stylesheet">
</head>
<body onload="show_list(0)">
<h1>RPG admin panel</h1>
<div>
    <label for="count_1">Count per page:</label>
    <select id="count_1" onchange="show_list(0)">
        <option value="3">3</option>
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="14">14</option>
    </select>
    <table id="TableBase">
        <thead>
        <tr>
            <th>#</th>
            <th>Name</th>
            <th>Title</th>
            <th>Race</th>
            <th>Profession</th>
            <th>Level</th>
            <th>Birthday</th>
            <th>Banned</th>
            <th>Edit</th>
            <th>Delete</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div id="paging_buttons">Pages:</div>
</div>

<script>
    function show_list(page_number) {
        $("tbody").remove()

        let url = "/rest/players?";
        let countPerPage = $("#count_1").val()

        if (countPerPage == null) {
            countPerPage = 3
        }
        url=url.concat("pageSize=").concat(countPerPage)

        if (page_number == null) {
            page_number = 0
        }

        url=url.concat("&pageNumber=").concat(page_number)

        $.get(url, function (response) {
            $.each(response, function (i, item) {
                $('<tbody>').html("<td>"
                    + item.id + "</td><td>"
                    + item.name + "</td><td>"
                    + item.title + "</td><td>"
                    + item.race + "</td><td>"
                    + item.profession + "</td><td>"
                    + item.level + "</td><td>"
                    + new Date(item.birthday).toLocaleDateString() + "</td><td>"
                    + item.banned + "</td><td>"
                    + "<button id='button_edit_" + item.id + "'>"
                    + "<img src='/img/edit.png'>"
                    + "</button>" + "</td><td>"
                    + "<button id='button_delete_" + item.id + "' onclick='deleteAcc(" + item.id + ")'>"
                    + "<img src='/img/delete.png'>"
                    + "</button>" + "</td>"
                ).appendTo("#TableBase");
            })

        })

        let totalCount = getTotalCount()


        let pagesCount=Math.ceil(totalCount/countPerPage)

        $("button.pgn-btn-styled").remove();

        for (let i = 0; i < pagesCount; i++) {
            let button_tag="<button>" + (i + 1) + "</button>"
            let btn=$(button_tag)
                .attr('id', "paging_button_" + i)
                .attr('onclick', "show_list(" + i + ")")
                .attr('on', "false")
                .addClass('pgn-btn-styled')
            $('#paging_buttons').append(btn)
        }

        let identifier = "#paging_button_" + page_number;
        $(identifier).css('background', "grey", 'color', "red");
        $(identifier).css('color', "red");
        $(identifier).attr('on',"true");
    }

    function getTotalCount() {
        let url = "/rest/players/count"
        let res = 0
        $.ajax({
            url: url,
            async: false,
            success: function (result) {
                res = parseInt(result)
            }
        })
        console.log(res)
        return res
    }

    function deleteAcc(id) {
        let url="/rest/players/" + id;
        $.ajax({
            url: url,
            type: 'DELETE',
            success: function () {
                show_list(getCurrentPage())
            }
        })
    }

    function getCurrentPage() {
        let current_page = 1;
        $('button:parent(paging_buttons)').each(function () {
            if ($(this).attr('on') === 'true') {
                current_page=$(this).text();
                console.log("current_page= " + current_page)
            }
        })
        return parseInt(current_page) - 1;
    }

</script>
</body>
</html>